{% load staticfiles %}
{% load cms_tags %}
{% load menu_tags %}
{% load sekizai_tags %}
{% load tags_accounts %}
<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">
        <!--<link rel="icon" href="images/favicon.ico" type="image/x-icon" />-->

        <title>{% block title %}This is my new project home page{% endblock title %}</title>

        <!-- Bootstrap core CSS -->
        <link href="{% static 'css/bootstrap/bootstrap.min.css' %}" rel="stylesheet">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

        {% render_block "css" %}

        <link rel="stylesheet" href="{% static 'css/styles.css' %}" />  
    </head>

    <body>
        {% cms_toolbar %}

        <nav class="navbar navbar-default navbar-fixed-top hide" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">Project name</a>
                </div>

                <div id="navbar" class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        {% show_menu 0 100 100 100 %}
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container search_area width1000">
            <div class="col-xs-8">
                dgdgdfgdfgfdgfd
            </div>

            <div class="col-xs-4 auth_block">
                <button class="btn btn-primary btn-sm pull-right" id="regButton">Зарегистрироваться</button>

                <button class="btn btn-primary btn-sm pull-right" id="authButton">Войти</button>
            </div>            
        </div>

        <div class="container content_area width1000">
            {% block content %}
            {% endblock content %}
        </div>        

        <div class="footer footer_area width1000">
            <div class="container">
                <p class="text-muted">Place sticky footer content here.</p>
            </div>
        </div>

        <!-- common modal -->
        <div class="modal fade" id="commonModal" tabindex="-1" role="dialog" aria-labelledby="commonModalLabel" aria-hidden="true">
            <div class="modal-dialog" id="modalDialog">
                <div class="modal-content" id="modalContent">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        
                        <h4 class="modal-title" id="commonModalLabel">Modal title</h4>
                    </div>

                    <div class="modal-body"></div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default but_cancel" id="butCancel" data-dismiss="modal">Отменить</button>
                        <button type="button" class="btn btn-primary but_ok" id="butOk" data-dismiss="modal">Ok</button>
                    </div>
                </div>
            </div>
        </div>        

        <!-- registration window -->
        {% part_reg_form %}

        <!-- auth window -->
        {% part_auth_form %}

        <!-- jquery -->
        <script src="{% static 'js/jquery/jquery.2.min.js' %}"></script>

        <!-- Bootstrap -->
        <script src="{% static 'js/bootstrap/bootstrap.min.js' %}"></script>         

        <!-- validate -->
        <script src="{% static 'js/jquery_validate/jquery.validate.min.js' %}"></script>                

        <script>
            $.validator.setDefaults({
                submitHandler: function() {
                    var flag = false,
                        username = $('#id_username'),
                        email = $('#id_email'),
                        password1 = $('#id_password1'),
                        password2 = $('#id_password2'),                        
                        usernameVal = $.trim(username.val()),
                        emailVal = $.trim(email.val()),
                        password1Val = $.trim(password1.val()),
                        password2Val = $.trim(password2.val()),                        
                        csrfmiddlewaretokenVal = $('#registrationForm input[name=csrfmiddlewaretoken]').val();

                    $.ajax({
                        url: "/accounts/ajax_reg_form_check/",
                        type: 'POST',
                        dataType:"json",
                        data: {
                            "username": usernameVal,
                            "email": emailVal,
                            "csrfmiddlewaretoken": csrfmiddlewaretokenVal
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            //console.log(xhr.status);
                            //console.log(xhr.responseText);
                            //console.log(thrownError);                 
                        },
                        success: function(data) {
                            //console.log(data.result);

                            if(data.username){
                                // ret true - matched, no reg
                                username.addClass('shine');
                                flag = true;
                            }
                            else{
                                // ret true - no matched, ok reg
                                username.removeClass('shine');
                            }


                            if(data.email){
                                // ret true - matched, no reg
                                email.addClass('shine');
                                flag = true;
                            }
                            else{
                                // ret true - no matched, ok reg
                                email.removeClass('shine');
                            }                            
                        },
                        complete: function(){
                            if(!flag){
                                $.ajax({
                                    url: "/accounts/registration/",
                                    type: 'POST',
                                    dataType:"json",
                                    data: {
                                        "username": usernameVal,
                                        "email": emailVal,
                                        "password1": password1Val,
                                        "password2": password2Val,
                                        "csrfmiddlewaretoken": $('#registrationForm input[name=csrfmiddlewaretoken]').val()
                                    },
                                    error: function(xhr, ajaxOptions, thrownError) {
                                        //console.log(xhr.status);
                                        //console.log(xhr.responseText);
                                        //console.log(thrownError);                 
                                    },
                                    success: function(data) {
                                        //console.log('success');

                                        username.val('');
                                        email.val('');
                                        password1.val('');
                                        password2.val('');

                                        $('#regModal').modal('hide');

                                        $('#commonModalLabel').text('Регистрация завершена успешно');
                                        $('#modalDialog').addClass('modal-sm');
                                        $('#butCancel').addClass('hide');
                                        $('#commonModal').modal('show');

                                        setTimeout(function(){
                                            $('#commonModal').modal('hide');
                                        }, 2000);   
                                    }
                                }); 
                            }
                        }
                    });

                    
                }
            });

            $().ready(function() {
                // validate signup form on keyup and submit
                $("#registrationForm").validate({
                    rules: {
                        username: {
                            required: true,
                            maxlength: 30,
                            minlength: 3
                        },
                        password1: {
                            required: true,
                            maxlength: 30,
                            minlength: 3
                        },
                        password2: {
                            required: true,
                            maxlength: 30,
                            minlength: 3,
                            equalTo: "#id_password1"
                        },
                        email: {
                            required: true,
                            maxlength: 30,
                            minlength: 3,                            
                            email: true
                        }
                    },
                    messages: {
                        username: {
                            required: "Please enter a username",
                            minlength: "Your username must consist of at least 3 characters",
                            maxlength: "Your username must consist of at least 30 characters"
                        },
                        password: {
                            required: "Please provide a password",
                            minlength: "Your username must consist of at least 6 characters",
                            maxlength: "Your username must consist of at least 30 characters"
                        },
                        confirm_password: {
                            required: "Please provide a password",
                            minlength: "Your username must consist of at least 6 characters",
                            maxlength: "Your username must consist of at least 30 characters",
                            equalTo: "Please enter the same password as above"
                        },
                        email: {
                            required: "Please enter a valid email address",
                            minlength: "Your username must consist of at least 6 characters",
                            maxlength: "Your username must consist of at least 30 characters"                        
                        }
                    }
                });
            });
        </script>

        <!-- helper -->  
        <script src="{% static "js/helper/helper.js" %}"></script>       

        {% render_block "js" %}
    </body>
</html>
